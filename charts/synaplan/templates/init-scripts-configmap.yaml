apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "synaplan.fullname" . }}-init-scripts
  labels:
    {{- include "synaplan.labels" . | nindent 4 }}
data:
  {{- if .Values.customRootCA }}
  00-setup-ca.sh: |
    #!/bin/bash
    # Setup custom root CA certificates

    echo "ğŸ” Setting up custom root CA certificates..."

    update-ca-certificates
    echo "openssl.cafile=/etc/ssl/certs/ca-certificates.crt" > /usr/local/etc/php/conf.d/custom-ca.ini
    echo "curl.cainfo=/etc/ssl/certs/ca-certificates.crt" >> /usr/local/etc/php/conf.d/custom-ca.ini

    echo "âœ… Custom CA certificates configured"
  {{- end }}

  01-setup-env.sh: |
    #!/bin/bash
    # Create .env file with DATABASE URLs
    # Note: docker-entrypoint also builds these URLs and exports them,
    # but Symfony requires .env file to exist for bootEnv

    cat > /var/www/backend/.env <<EOF
    DATABASE_WRITE_URL=mysql://\${DB_USER}:\${DB_PASSWORD}@\${DB_HOST}:\${DB_PORT}/\${DB_NAME}?serverVersion=\${DB_SERVER_VERSION}&charset=utf8mb4
    DATABASE_READ_URL=mysql://\${DB_USER}:\${DB_PASSWORD}@\${DB_HOST}:\${DB_PORT}/\${DB_NAME}?serverVersion=\${DB_SERVER_VERSION}&charset=utf8mb4
    EOF

  50-wait-database.sh: |
    #!/bin/bash
    # Wait for database connection to be ready
    # All scripts numbered 51+ will run after database is available

    echo "â³ Waiting for database connection..."

    cd /var/www/backend

    for i in {1..60}; do
      if php bin/console dbal:run-sql "SELECT 1" > /dev/null 2>&1; then
        echo "âœ… Database is ready!"
        exit 0
      fi
      sleep 1
    done

    echo "âŒ Database not ready after 60 seconds"
    exit 1

  51-init-models.sh: |
    #!/bin/bash
    # Initialize default models for Triton/Mistral
    # Runs after database is ready (50-wait-database.sh)

    echo "ğŸ”§ Initializing default AI models..."

    cd /var/www/backend

    # Note: SQL queries below use hardcoded strings only (no variable interpolation)
    # This is safe from SQL injection as all values are defined in the Helm template
    #
    # The hardcoded BID=100 is intentional and uses ON DUPLICATE KEY UPDATE to:
    # - Ensure idempotent behavior (safe to run on every pod start)
    # - Keep model configuration up-to-date if the chart is updated
    # - Provide a deterministic ID for the default Triton model
    {{- if eq .Values.tritonMode "gpu" }}
    # Insert Triton Mistral model for GPU mode (uses mistral-streaming with TensorRT-LLM backend)
    if php bin/console dbal:run-sql "INSERT INTO BMODELS (BID, BSERVICE, BNAME, BTAG, BSELECTABLE, BACTIVE, BPROVID, BPRICEIN, BINUNIT, BPRICEOUT, BOUTUNIT, BQUALITY, BRATING, BISDEFAULT, BDESCRIPTION, BJSON) VALUES (100, 'triton', 'mistral-7b (streaming)', 'chat', 1, 1, 'mistral-streaming', 0.0, 'per1M', 0.0, 'per1M', 7.0, 0.5, 1, 'Mistral 7B model via Triton Inference Server with GPU acceleration and streaming support', '{\"description\": \"Triton Inference Server model with TensorRT-LLM backend and streaming capabilities\", \"features\": [\"streaming\", \"gpu\"], \"supportsStreaming\": true}') ON DUPLICATE KEY UPDATE BSERVICE = VALUES(BSERVICE), BNAME = VALUES(BNAME), BPROVID = VALUES(BPROVID), BJSON = VALUES(BJSON)" 2>&1 | grep -q "rows affected"; then
      echo "   âœ… Triton model registered (GPU mode: mistral-streaming)"
    else
      echo "   âŒ Failed to register Triton model"
      exit 1
    fi
    {{- else }}
    # Insert Triton Mistral model for CPU mode (uses mistral-cpu with PyTorch backend)
    if php bin/console dbal:run-sql "INSERT INTO BMODELS (BID, BSERVICE, BNAME, BTAG, BSELECTABLE, BACTIVE, BPROVID, BPRICEIN, BINUNIT, BPRICEOUT, BOUTUNIT, BQUALITY, BRATING, BISDEFAULT, BDESCRIPTION, BJSON) VALUES (100, 'triton', 'mistral-7b (cpu)', 'chat', 1, 1, 'mistral-cpu', 0.0, 'per1M', 0.0, 'per1M', 7.0, 0.5, 1, 'Mistral 7B model via Triton Inference Server with CPU inference', '{\"description\": \"Triton Inference Server model with PyTorch CPU backend\", \"features\": [\"cpu\", \"streaming\"], \"supportsStreaming\": true}') ON DUPLICATE KEY UPDATE BSERVICE = VALUES(BSERVICE), BNAME = VALUES(BNAME), BPROVID = VALUES(BPROVID), BJSON = VALUES(BJSON)" 2>&1 | grep -q "rows affected"; then
      echo "   âœ… Triton model registered (CPU mode: mistral-cpu)"
    else
      echo "   âŒ Failed to register Triton model"
      exit 1
    fi
    {{- end }}

    echo "âœ… Default models initialized"
